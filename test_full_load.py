import sys
import os
import pandas as pd

# –î–æ–¥–∞—î–º–æ —à–ª—è—Ö –¥–æ –ø–∞–ø–∫–∏ src, —â–æ–± –±–∞—á–∏—Ç–∏ –Ω–∞—à —Ñ–∞–π–ª data_loader.py
sys.path.append(os.path.join(os.getcwd(), 'src'))

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é (–ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —Ç–∏ —Å—Ç–≤–æ—Ä–∏–ª–∞ src/data_loader.py!)
try:
    from data_loader import load_all_data
except ImportError:
    # –Ø–∫—â–æ —Ç–∏ –Ω–µ —Å—Ç–≤–æ—Ä–∏–ª–∞ —Ñ–∞–π–ª, –≤—Å—Ç–∞–≤ —Ñ—É–Ω–∫—Ü—ñ—é load_all_data –ø—Ä—è–º–æ —Å—é–¥–∏
    print("‚ö†Ô∏è –§–∞–π–ª data_loader.py –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω—É –ª–æ–≥—ñ–∫—É...")
    # (–¢—É—Ç –º–∞–≤ –±–∏ –±—É—Ç–∏ –∫–æ–¥ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫—â–æ —Ç–∏ –≤–∏—Ä—ñ—à–∏–ª–∞ –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ñ–∞–π–ª)
    pass 

def run_test():
    # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –í–°–ï (—Ü–µ –º–æ–º–µ–Ω—Ç —ñ—Å—Ç–∏–Ω–∏ –¥–ª—è RAM)
    # –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —à–ª—è—Ö–∏ –¥–æ —Ñ–∞–π–ª—ñ–≤ —É –ø–∞–ø—Ü—ñ data/raw –ø—Ä–∞–≤–∏–ª—å–Ω—ñ!
    # –ó–≤–µ—Ä–Ω–∏ —É–≤–∞–≥—É: —É —Ç–µ–±–µ –≤ –∫–æ–Ω—Å–æ–ª—ñ —Ñ–∞–π–ª –∑ –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è–º '_', –∞ –≤ —É–º–æ–≤—ñ —ñ–Ω–æ–¥—ñ –ø—Ä–æ–±—ñ–ª–∏.
    # –ü–µ—Ä–µ–≤—ñ—Ä –Ω–∞–∑–≤–∏ —Ñ–∞–π–ª—ñ–≤ —É –ø–∞–ø—Ü—ñ!
    
    print("‚è≥ –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ 10 –º–ª–Ω —Ä—è–¥–∫—ñ–≤...")
    try:
        # –í–∫–∞–∂–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö –¥–æ –ø–∞–ø–∫–∏ –∑ CSV
        df = load_all_data(base_path='data/raw') 
        
        print(f"\n‚úÖ –£–°–ü–Ü–•! –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ {len(df)} —Ä—è–¥–∫—ñ–≤.")
        print(f"–†–æ–∑–º—ñ—Ä —É –ø–∞–º'—è—Ç—ñ: {df.memory_usage(deep=True).sum() / 1024**3 :.2f} GB")
        
        # 2. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±—Ä–æ–±–ª–µ–Ω–∏–π —Ñ–∞–π–ª —É —Ñ–æ—Ä–º–∞—Ç—ñ Parquet (—Ü–µ –Ω–∞–±–∞–≥–∞—Ç–æ —à–≤–∏–¥—à–µ –Ω—ñ–∂ CSV)
        # –ù–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞–∑—É —Ç–∏ –±—É–¥–µ—à —á–∏—Ç–∞—Ç–∏ —Ü–µ–π –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É.
        output_file = 'data/processed/all_data_compressed.parquet'
        os.makedirs('data/processed', exist_ok=True)
        
        print(f"üíæ –ó–±–µ—Ä—ñ–≥–∞—é —É {output_file}...")
        df.to_parquet(output_file)
        print("üéâ –ó–±–µ—Ä–µ–∂–µ–Ω–æ! –¢–µ–ø–µ—Ä –ø—Ä–∞—Ü—é–π —Ç—ñ–ª—å–∫–∏ –∑ —Ü–∏–º —Ñ–∞–π–ª–æ–º.")
        
    except MemoryError:
        print("‚ùå –ù–ï –í–ò–°–¢–ê–ß–ò–õ–û –ü–ê–ú'–Ø–¢–Ü! –¢—Ä–µ–±–∞ –≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª–∏ –ø–æ —á–µ—Ä–∑—ñ –∞–±–æ –∑–º–µ–Ω—à–∏—Ç–∏ —Ç–∏–ø–∏ –¥–∞–Ω–∏—Ö.")
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")

if __name__ == "__main__":
    run_test()